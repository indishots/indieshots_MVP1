<!DOCTYPE html>
<html>
<head>
    <title>PayU Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        textarea { width: 100%; height: 100px; margin: 10px 0; }
        .payment-params { background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>IndieShots PayU Integration Test</h1>
    
    <div class="test-section">
        <h2>1. Environment Variables Check</h2>
        <div id="env-status" class="status info">Checking PayU configuration...</div>
        <button onclick="checkEnvironment()">Check PayU Config</button>
    </div>
    
    <div class="test-section">
        <h2>2. Test PayU Hash Generation</h2>
        <div id="hash-status" class="status info">Ready to test hash generation</div>
        <button onclick="testHashGeneration()">Test Hash Generation</button>
        <div id="hash-details"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Create Test Payment Session</h2>
        <div id="payment-status" class="status info">Ready to create payment session</div>
        <input type="email" id="test-email" placeholder="test@example.com" value="testuser@example.com">
        <button onclick="createTestPayment()">Create Test Payment</button>
        <div id="payment-details"></div>
    </div>
    
    <div class="test-section">
        <h2>4. PayU Form Submission Test</h2>
        <div id="form-status" class="status info">Complete steps above first</div>
        <button onclick="submitToPayU()" id="payu-submit-btn" disabled>Submit to PayU Gateway</button>
        <div id="form-details"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <textarea id="test-results" readonly placeholder="Test results will appear here..."></textarea>
    </div>

    <script>
        let testResults = [];
        let paymentParams = null;
        
        function log(message) {
            testResults.push(`${new Date().toLocaleTimeString()}: ${message}`);
            document.getElementById('test-results').value = testResults.join('\n');
            console.log(message);
        }
        
        async function checkEnvironment() {
            try {
                log('Checking PayU environment variables...');
                const response = await fetch('/api/payu/config-status');
                const data = await response.json();
                
                if (data.configured) {
                    document.getElementById('env-status').className = 'status success';
                    document.getElementById('env-status').textContent = `✅ PayU configured: ${data.summary}`;
                    log('✅ PayU environment variables properly configured');
                } else {
                    document.getElementById('env-status').className = 'status error';
                    document.getElementById('env-status').textContent = '❌ PayU not properly configured';
                    log('❌ PayU environment variables missing or incorrect');
                }
            } catch (error) {
                document.getElementById('env-status').className = 'status error';
                document.getElementById('env-status').textContent = '❌ Failed to check PayU config';
                log(`❌ Environment check failed: ${error.message}`);
            }
        }
        
        async function testHashGeneration() {
            try {
                log('Testing PayU hash generation...');
                const response = await fetch('/api/payu/test-hash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        amount: 29,
                        txnid: 'TEST_' + Date.now()
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('hash-status').className = 'status success';
                    document.getElementById('hash-status').textContent = '✅ Hash generation successful';
                    document.getElementById('hash-details').innerHTML = `
                        <div class="payment-params">
                            <strong>Hash Details:</strong><br>
                            Hash String: ${data.hashString}<br>
                            Generated Hash: ${data.hash.substring(0, 20)}...<br>
                            PayU Format Verified: ✅
                        </div>
                    `;
                    log('✅ PayU hash generation working correctly');
                } else {
                    document.getElementById('hash-status').className = 'status error';
                    document.getElementById('hash-status').textContent = '❌ Hash generation failed';
                    log(`❌ Hash generation failed: ${data.error}`);
                }
            } catch (error) {
                document.getElementById('hash-status').className = 'status error';
                document.getElementById('hash-status').textContent = '❌ Hash test failed';
                log(`❌ Hash test failed: ${error.message}`);
            }
        }
        
        async function createTestPayment() {
            try {
                const email = document.getElementById('test-email').value;
                log(`Creating test payment session for ${email}...`);
                
                const response = await fetch('/api/payu/create-test-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        amount: 29,
                        firstname: 'Test User'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('payment-status').className = 'status success';
                    document.getElementById('payment-status').textContent = '✅ Payment session created';
                    
                    paymentParams = data.paymentParams;
                    document.getElementById('payment-details').innerHTML = `
                        <div class="payment-params">
                            <strong>Payment Parameters:</strong><br>
                            Transaction ID: ${data.paymentParams.txnid}<br>
                            Amount: ₹${data.paymentParams.amount}<br>
                            Email: ${data.paymentParams.email}<br>
                            Hash: ${data.paymentParams.hash.substring(0, 20)}...<br>
                            PayU URL: ${data.paymentUrl}
                        </div>
                    `;
                    
                    document.getElementById('payu-submit-btn').disabled = false;
                    log('✅ Payment session created successfully');
                    log(`Transaction ID: ${data.paymentParams.txnid}`);
                } else {
                    document.getElementById('payment-status').className = 'status error';
                    document.getElementById('payment-status').textContent = '❌ Payment session creation failed';
                    log(`❌ Payment creation failed: ${data.error}`);
                }
            } catch (error) {
                document.getElementById('payment-status').className = 'status error';
                document.getElementById('payment-status').textContent = '❌ Payment test failed';
                log(`❌ Payment test failed: ${error.message}`);
            }
        }
        
        function submitToPayU() {
            if (!paymentParams) {
                alert('Please create a payment session first');
                return;
            }
            
            try {
                log('Creating PayU payment form...');
                
                // Create form for PayU submission
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'https://secure.payu.in/_payment';
                form.target = '_blank';
                
                // Add all payment parameters
                Object.entries(paymentParams).forEach(([key, value]) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = String(value);
                    form.appendChild(input);
                });
                
                document.body.appendChild(form);
                
                document.getElementById('form-status').className = 'status success';
                document.getElementById('form-status').textContent = '✅ Submitting to PayU gateway...';
                document.getElementById('form-details').innerHTML = `
                    <div class="payment-params">
                        <strong>Form submitted to PayU production gateway</strong><br>
                        Opening PayU payment page in new tab...<br>
                        Transaction: ${paymentParams.txnid}
                    </div>
                `;
                
                log('✅ Submitting form to PayU production gateway');
                log(`Opening PayU payment page for transaction: ${paymentParams.txnid}`);
                
                form.submit();
                document.body.removeChild(form);
                
            } catch (error) {
                document.getElementById('form-status').className = 'status error';
                document.getElementById('form-status').textContent = '❌ PayU submission failed';
                log(`❌ PayU submission failed: ${error.message}`);
            }
        }
        
        // Auto-start tests
        window.onload = function() {
            log('🚀 PayU Integration Test Started');
            checkEnvironment();
        };
    </script>
</body>
</html>