<!DOCTYPE html>
<html>
<head>
    <title>PayU Real Payment Test - IndieShots</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; background: #f8f9fa; }
        .test-card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 15px; border-radius: 5px; margin: 15px 0; }
        button { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px; font-size: 16px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .payu-btn { background: #28a745; }
        .payu-btn:hover { background: #218838; }
        .payment-params { background: #f8f9fa; padding: 20px; border: 2px solid #dee2e6; border-radius: 8px; margin: 15px 0; font-family: monospace; font-size: 14px; }
        .payment-params h4 { margin-top: 0; color: #495057; }
        input[type="email"] { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; margin: 10px 0; font-size: 16px; }
        .step { margin: 20px 0; padding: 20px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .step h3 { margin-top: 0; color: #007bff; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .test-result.pass { background: #d4edda; color: #155724; }
        .test-result.fail { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="test-card">
        <h1>üî• IndieShots PayU Real Payment Test</h1>
        <div class="success">
            <strong>‚úÖ PayU Production Gateway Integration Ready!</strong><br>
            This test will create a real payment session using production PayU credentials and redirect you to the actual PayU gateway where you can test QR codes, UPI, PhonePe, cards, and net banking.
        </div>
        
        <div class="warning">
            <strong>‚ö†Ô∏è Important:</strong> This uses REAL PayU production gateway. Only proceed if you want to test actual payment processing. You can cancel the payment on PayU's page if needed.
        </div>
    </div>

    <div class="test-card">
        <div class="step">
            <h3>Step 1: Configuration Verification</h3>
            <div id="config-result" class="test-result">Checking PayU configuration...</div>
            <button onclick="checkConfig()">Verify PayU Config</button>
        </div>

        <div class="step">
            <h3>Step 2: Hash Generation Test</h3>
            <div id="hash-result" class="test-result">Ready to test hash generation</div>
            <button onclick="testHash()" id="hash-btn" disabled>Test Hash Generation</button>
        </div>

        <div class="step">
            <h3>Step 3: Create Real Payment Session</h3>
            <input type="email" id="test-email" placeholder="Enter your email" value="">
            <div id="payment-result" class="test-result">Enter email and create payment session</div>
            <button onclick="createPayment()" id="payment-btn" disabled>Create PayU Payment Session</button>
        </div>

        <div class="step">
            <h3>Step 4: PayU Gateway Submission</h3>
            <div id="gateway-result" class="test-result">Complete steps above first</div>
            <button onclick="submitToPayU()" id="gateway-btn" disabled class="payu-btn">üöÄ Submit to PayU Production Gateway</button>
        </div>
    </div>

    <div class="test-card" id="payment-details" style="display:none;">
        <h3>Payment Session Details</h3>
        <div class="payment-params" id="payment-params-display"></div>
        
        <div class="info">
            <strong>What happens next:</strong><br>
            1. Click "Submit to PayU Production Gateway" button<br>
            2. PayU payment page opens in new tab<br>
            3. Test QR codes, UPI, PhonePe, cards, or net banking<br>
            4. You can cancel payment if testing<br>
            5. Success/failure redirects back to IndieShots
        </div>
    </div>

    <script>
        let paymentParams = null;
        let configOk = false;
        let hashOk = false;
        
        function updateResult(elementId, message, className) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `test-result ${className}`;
        }
        
        async function checkConfig() {
            try {
                updateResult('config-result', 'Checking PayU configuration...', 'info');
                
                const response = await fetch('/api/payu/config-status');
                const data = await response.json();
                
                if (data.configured) {
                    updateResult('config-result', `‚úÖ PayU PRODUCTION configured: ${data.summary}`, 'pass');
                    configOk = true;
                    document.getElementById('hash-btn').disabled = false;
                } else {
                    updateResult('config-result', `‚ùå PayU not configured: ${data.summary}`, 'fail');
                }
            } catch (error) {
                updateResult('config-result', `‚ùå Config check failed: ${error.message}`, 'fail');
            }
        }
        
        async function testHash() {
            if (!configOk) return;
            
            try {
                updateResult('hash-result', 'Testing PayU hash generation...', 'info');
                
                const response = await fetch('/api/payu/test-hash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        amount: 29,
                        txnid: 'TEST_' + Date.now()
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateResult('hash-result', `‚úÖ Hash generation working! Format: ${data.payuFormat}`, 'pass');
                    hashOk = true;
                    document.getElementById('payment-btn').disabled = false;
                } else {
                    updateResult('hash-result', `‚ùå Hash generation failed: ${data.error}`, 'fail');
                }
            } catch (error) {
                updateResult('hash-result', `‚ùå Hash test failed: ${error.message}`, 'fail');
            }
        }
        
        async function createPayment() {
            if (!hashOk) return;
            
            const email = document.getElementById('test-email').value.trim();
            if (!email) {
                updateResult('payment-result', '‚ùå Please enter your email address', 'fail');
                return;
            }
            
            try {
                updateResult('payment-result', 'Creating real PayU payment session...', 'info');
                
                const response = await fetch('/api/payu/create-test-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        amount: 29,
                        firstname: email.split('@')[0]
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    paymentParams = data.paymentParams;
                    
                    updateResult('payment-result', `‚úÖ Payment session created! Transaction: ${data.txnid}`, 'pass');
                    updateResult('gateway-result', 'Ready to submit to PayU production gateway', 'info');
                    
                    document.getElementById('gateway-btn').disabled = false;
                    document.getElementById('payment-details').style.display = 'block';
                    
                    document.getElementById('payment-params-display').innerHTML = `
                        <h4>PayU Payment Parameters:</h4>
                        <strong>Transaction ID:</strong> ${data.paymentParams.txnid}<br>
                        <strong>Amount:</strong> ‚Çπ${data.paymentParams.amount}<br>
                        <strong>Email:</strong> ${data.paymentParams.email}<br>
                        <strong>Merchant Key:</strong> ${data.paymentParams.key}<br>
                        <strong>PayU Gateway:</strong> ${data.paymentUrl}<br>
                        <strong>Hash:</strong> ${data.paymentParams.hash.substring(0, 40)}...<br>
                        <strong>Success URL:</strong> ${data.paymentParams.surl}<br>
                        <strong>Failure URL:</strong> ${data.paymentParams.furl}
                    `;
                } else {
                    updateResult('payment-result', `‚ùå Payment creation failed: ${data.error}`, 'fail');
                }
            } catch (error) {
                updateResult('payment-result', `‚ùå Payment creation failed: ${error.message}`, 'fail');
            }
        }
        
        function submitToPayU() {
            if (!paymentParams) {
                updateResult('gateway-result', '‚ùå No payment session available', 'fail');
                return;
            }
            
            try {
                updateResult('gateway-result', 'üöÄ Creating PayU form and redirecting...', 'info');
                
                // Create form for PayU submission
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'https://secure.payu.in/_payment';
                form.target = '_blank';
                
                // Add all payment parameters
                Object.entries(paymentParams).forEach(([key, value]) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = String(value);
                    form.appendChild(input);
                    console.log(`PayU Field: ${key} = ${String(value).length > 50 ? String(value).substring(0, 50) + '...' : String(value)}`);
                });
                
                document.body.appendChild(form);
                
                // Submit form
                console.log('üöÄ Submitting to PayU Production Gateway');
                console.log('Transaction ID:', paymentParams.txnid);
                console.log('Gateway URL:', form.action);
                
                form.submit();
                document.body.removeChild(form);
                
                updateResult('gateway-result', '‚úÖ Submitted to PayU! Check new tab for payment page', 'pass');
                
                // Update button text
                document.getElementById('gateway-btn').textContent = '‚úÖ Submitted - Check PayU Tab';
                document.getElementById('gateway-btn').disabled = true;
                
            } catch (error) {
                updateResult('gateway-result', `‚ùå Gateway submission failed: ${error.message}`, 'fail');
            }
        }
        
        // Auto-start configuration check
        window.onload = function() {
            console.log('üöÄ PayU Real Payment Test Started');
            checkConfig();
        };
    </script>
</body>
</html>